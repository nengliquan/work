<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®éªŒè¯</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f7; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; max-width: 320px; }
        h3 { margin: 0 0 10px 0; color: #1d1d1f; }
        p { color: #86868b; font-size: 14px; line-height: 1.6; margin-bottom: 25px; }
        .btn { background: #0071e3; color: white; border: none; padding: 12px 0; border-radius: 25px; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; display: block; }
        .btn:active { opacity: 0.8; }
        .tag { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #fff1f0; color: #ff4d4f; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="card">
    <h3>éœ€äºŒæ¬¡ç¡®è®¤ä½ç½®</h3>
    <!-- é»˜è®¤æ–‡æ¡ˆï¼ˆå¯¹åº” IP åœ¨åŒ—äº¬ä½†éœ€å¼ºåˆ¶éªŒè¯çš„æƒ…å†µï¼‰ -->
    <div class="tag" id="error-tag">éœ€ç²¾ç¡®ä½ç½®æ ¸éªŒ</div>
    <p id="msg-content">ä¸ºäº†ç¡®ä¿äº¤ä»˜å®‰å…¨ï¼Œ<b>æ‰€æœ‰è®¾å¤‡</b>éœ€æˆæƒ GPS ä»¥ç²¾ç¡®ç¡®è®¤ä½ç½®ã€‚</p>
    
    <button class="btn" onclick="startGPS()">ğŸ“ éªŒè¯æˆ‘çš„ä½ç½®</button>
    <div id="log" style="margin-top:15px; font-size:12px; color:#999;"></div>
</div>
<script>
    // 1. è¯»å– URL å‚æ•°å¹¶æ›´æ–°æç¤ºæ–‡æ¡ˆ
    const params = new URLSearchParams(window.location.search);
    const tag = params.get('tag');
    const msg = params.get('msg');
    const city = params.get('city') || 'Unknown';
    const region = params.get('region') || 'Unknown';
    
    // è·å–ç»çº¬åº¦èŒƒå›´é…ç½®
    const latMin = parseFloat(params.get('lat_min')) || 39.3;
    const latMax = parseFloat(params.get('lat_max')) || 41.7;
    const lonMin = parseFloat(params.get('lon_min')) || 115.3;
    const lonMax = parseFloat(params.get('lon_max')) || 117.6;
    
    if (tag) document.getElementById('error-tag').innerText = tag;
    if (msg) document.getElementById('msg-content').innerHTML = msg;

    // 2. GPS éªŒè¯é€»è¾‘
    function startGPS() {
        const log = document.getElementById('log');
        log.innerText = "æ­£åœ¨è·å–å«æ˜Ÿä¿¡å·...";
        if (!navigator.geolocation) { alert("æµè§ˆå™¨ä¸æ”¯æŒå®šä½"); return; }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                log.innerText = "åæ ‡è·å–æˆåŠŸ: " + lat.toFixed(2) + ", " + lon.toFixed(2);
                
                // æ„å»ºæºå¸¦ä¿¡æ¯çš„æŸ¥è¯¢å‚æ•°
                const queryParams = `?city=${encodeURIComponent(city)}&region=${encodeURIComponent(region)}&lat=${lat.toFixed(6)}&lon=${lon.toFixed(6)}`;

                if (lat > latMin && lat < latMax && lon > lonMin && lon < lonMax) {
                    log.innerText = "éªŒè¯é€šè¿‡ï¼è·³è½¬ä¸­...";
                    document.cookie = "gps_pass=1; path=/; max-age=3600";
                    sessionStorage.setItem('Tc_auth', '1');
                    window.location.href = "/success.html" + queryParams;
                } else {
                    sessionStorage.setItem('Tc_auth', '1');
                    window.location.href = "/blocked.html" + queryParams;
                }
            },
            (err) => {
                console.error(err);
                if (err.code === 1) {
                    sessionStorage.setItem('Tc_auth', '1');
                    const queryParams = `?city=${encodeURIComponent(city)}&region=${encodeURIComponent(region)}&lat=0&lon=0`;
                    window.location.href = "/blocked.html" + queryParams;
                } else {
                    alert("å®šä½è¶…æ—¶ï¼Œè¯·ç¡®ä¿ GPS å·²æ‰“å¼€å¹¶é‡è¯•");
                    log.innerText = "å®šä½å¤±è´¥ï¼Œè¯·é‡è¯•";
                }
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }
</script>
</body>
</html>