<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®éªŒè¯</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f7; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; max-width: 320px; }
        h3 { margin: 0 0 10px 0; color: #1d1d1f; }
        p { color: #86868b; font-size: 14px; line-height: 1.6; margin-bottom: 25px; }
        .btn { background: #0071e3; color: white; border: none; padding: 12px 0; border-radius: 25px; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; display: block; }
        .btn:active { opacity: 0.8; }
        .tag { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #fff1f0; color: #ff4d4f; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h3>éœ€äºŒæ¬¡ç¡®è®¤ä½ç½®</h3>
    
    <div id="error-tag" class="tag" style="display:none;"></div>

    <p id="msg-content">ä¸ºäº†ä¿éšœé¡¹ç›®äº¤ä»˜å®‰å…¨ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨çš„ç½‘ç»œç¯å¢ƒéœ€è¦è¿›è¡Œç²¾ç¡®ä½ç½®æ ¸éªŒã€‚</p>

    <button class="btn" onclick="startGPS()">ğŸ“ éªŒè¯æˆ‘çš„ä½ç½®</button>
    <div id="log" style="margin-top:15px; font-size:12px; color:#999;"></div>
</div>

<script>
    // 1. æ ¹æ®è¢«æ‹¦æˆªçš„åŸå› ï¼Œä¿®æ”¹æç¤ºè¯­
    const params = new URLSearchParams(window.location.search);
    const reason = params.get('reason');
    const detected = params.get('detected');

    const errorTag = document.getElementById('error-tag');
    const msgContent = document.getElementById('msg-content');

    if (reason === 'ip_error') {
        // IP å®Œå…¨ä¸åœ¨åŒ—äº¬
        errorTag.innerText = "ç½‘ç»œä½ç½®: " + (detected || "éåŒ—äº¬");
        errorTag.style.display = "inline-block";
        msgContent.innerText = "æ‚¨çš„ç½‘ç»œ IP æ˜¾ç¤ºä¸åœ¨åŒ—äº¬åŒºåŸŸï¼ˆå¯èƒ½æ˜¯åŸºç«™ä¿¡å·æ¼‚ç§»ï¼‰ã€‚è¯·æˆæƒ GPS ç¡®è®¤æ‚¨åœ¨åŒ—äº¬ã€‚";
    } else if (reason === 'cellular') {
        // å®‰å“ 4G ç”¨æˆ·
        errorTag.innerText = "æ£€æµ‹åˆ°ç§»åŠ¨æ•°æ®ç½‘ç»œ";
        errorTag.style.display = "inline-block";
        msgContent.innerHTML = "æ‚¨æ­£åœ¨ä½¿ç”¨ <b>4G/5G ç½‘ç»œ</b>ï¼ŒåŸºç«™ä¿¡å·ææ˜“å‘ç”Ÿè·¨çœæ¼‚ç§»ã€‚è¯·æˆæƒ GPS ä»¥ç²¾ç¡®ç¡®è®¤ä½ç½®ã€‚";
    }

    // 2. GPS éªŒè¯é€»è¾‘
    function startGPS() {
        const log = document.getElementById('log');
        log.innerText = "æ­£åœ¨è·å–å«æ˜Ÿä¿¡å·...";

        if (!navigator.geolocation) {
            alert("æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                log.innerText = `åæ ‡è·å–æˆåŠŸ: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;

                // åŒ—äº¬çŸ©å½¢èŒƒå›´æ ¡éªŒ (ç¨å¾®æ”¾å®½ä¸€ç‚¹è¾¹ç¼˜)
                // çº¬åº¦ 39.3 - 41.7, ç»åº¦ 115.3 - 117.6
                if (lat > 39.3 && lat < 41.7 && lon > 115.3 && lon < 117.6) {
                    log.innerText = "éªŒè¯é€šè¿‡ï¼è·³è½¬ä¸­...";
                    // å†™å…¥ Cookie é€šè¡Œè¯ (æœ‰æ•ˆæœŸ1å°æ—¶)
                    document.cookie = "gps_pass=1; path=/; max-age=3600";
                    // è·³è½¬æˆåŠŸé¡µ
                    window.location.href = "/success.html";
                } else {
                    // çœŸçš„ä¸åœ¨åŒ—äº¬
                    window.location.href = "/blocked.html";
                }
            },
            (err) => {
                console.error(err);
                if (err.code === 1) alert("è¯·ç‚¹å‡»â€œå…è®¸â€ä»¥æˆäºˆä½ç½®æƒé™");
                else alert("å®šä½è¶…æ—¶ï¼Œè¯·ç¡®ä¿ GPS å·²æ‰“å¼€å¹¶é‡è¯•");
                log.innerText = "å®šä½å¤±è´¥ï¼Œè¯·é‡è¯•";
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }
</script>
</body>
</html>