<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>环境安全检测</title>
    <style>
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #fff; font-family: -apple-system, sans-serif; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007aff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { margin-top: 15px; color: #888; font-size: 14px; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <p>正在检测访问环境...</p>

    <script>
        // 这个页面只有“IP 已经在北京”的用户才会进来
        // 我们的任务是：把“用4G的手机用户”抓出来去验 GPS，其他人放行

        function checkEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobile = /iphone|ipad|ipod|android|mobile/.test(ua);

            // 1. 如果是电脑 (Windows/Mac) -> 信任 IP -> 放行
            if (!isMobile) {
                window.location.href = "/success.html";
                return;
            }

            // 2. 如果是手机 -> 检查网络类型
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            let isCellular = false;

            if (connection) {
                // 安卓精准检测
                if (connection.type === 'cellular' || connection.type === 'wimax') {
                    isCellular = true;
                }
            }

            // iOS 策略：由于 iOS 不支持检测网络类型，为了防止 4G 漂移漏洞
            // 你可以选择：
            // A. 宽松模式 (推荐)：iOS 一律放行 (会有少量 4G 漂移漏洞，但体验好)
            // B. 严格模式：iOS 一律验 GPS (最安全，但每次都要弹窗)
            
            // 这里我们采用【混合策略】：安卓4G必验，iOS放行(IP已过)
            
            if (isCellular) {
                // 是手机 + 明确是4G/5G -> 就算IP对也不信，去验 GPS
                window.location.href = "/verify.html?reason=cellular";
            } else {
                // 是手机 + WiFi (或无法检测的iOS) + IP已对 -> 放行
                window.location.href = "/success.html";
            }
        }

        // 稍微延时执行，防止页面切换太快
        setTimeout(checkEnvironment, 500);
    </script>
</body>
</html>